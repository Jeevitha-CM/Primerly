<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Primerly - Results</title>
    
    <!-- iOS PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Primerly">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2c5aa0">
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/static/logo.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/logo.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/logo.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;600;700&family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c5aa0;
            --primary-dark: #1e3f73;
            --primary-light: #4a7bc8;
            --accent-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'IBM Plex Sans', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            line-height: 1.6;
        }
        
        .navbar-dark {
            background-color: var(--primary-color) !important;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
        }
        
        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .text-primary {
            color: var(--primary-color) !important;
        }
        
        .border-primary {
            border-color: var(--primary-color) !important;
        }
        .logo-small { height: 28px; width: auto; }
        .container-fluid {
            max-width: 1400px;
        }
        .primer-card {
            border-left: 4px solid #007bff;
            transition: transform 0.2s;
            margin-bottom: 20px;
        }
        .primer-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .quality-badge {
            font-size: 14px;
            padding: 6px 12px;
            font-weight: 600;
        }
        .sequence-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        .sequence-display {
            font-family: 'IBM Plex Mono', ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        .sequence-line {
            display: flex;
            margin-bottom: 2px;
        }
        .line-number {
            color: #6c757d;
            font-weight: bold;
            min-width: 50px;
            margin-right: 10px;
            font-family: 'IBM Plex Mono', ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
        }
        .sequence-content {
            flex: 1;
            word-break: break-all;
        }
        .sequence-char {
            color: #2c3e50;
        }
        .primer-highlight {
            color: white;
            font-weight: bold;
            padding: 1px 2px;
            border-radius: 2px;
        }
        /* Extended unique colors for pairs 4-10 */
        .bg-pair4f { background-color: #6f42c1; }   /* purple */
        .bg-pair4r { background-color: #20c997; }   /* teal */
        .bg-pair5f { background-color: #e83e8c; }   /* pink */
        .bg-pair5r { background-color: #795548; }   /* brown */
        .bg-pair6f { background-color: #6610f2; }   /* indigo */
        .bg-pair6r { background-color: #ffbf00; }   /* amber */
        .bg-pair7f { background-color: #0dcaf0; }   /* cyan */
        .bg-pair7r { background-color: #84cc16; }   /* lime */
        .bg-pair8f { background-color: #001f3f; }   /* navy */
        .bg-pair8r { background-color: #ff7f50; }   /* coral */
        .bg-pair9f { background-color: #334155; }   /* slate */
        .bg-pair9r { background-color: #d4af37; }   /* gold */
        .bg-pair10f { background-color: #800000; }  /* maroon */
        .bg-pair10r { background-color: #38bdf8; }  /* sky */
        .primer-legend {
            display: flex;
            align-items: center;
            margin-right: 15px;
            margin-bottom: 5px;
        }
        .structure-diagram {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
        }
        .structure-art {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.2;
            margin: 0;
            color: #495057;
            background: white;
            border-radius: 4px;
            padding: 8px;
            border: 1px solid #e9ecef;
        }
        .hairpin-visual, .dimer-visual {
            text-align: center;
        }
        .bond-line {
            color: #007bff;
            font-weight: bold;
        }
        .primer-sequence {
            color: #28a745;
            font-weight: bold;
        }
        .complement-sequence {
            color: #dc3545;
            font-weight: bold;
        }
        .gc-clamp-highlight {
            background: #ffc107;
            color: #000;
            font-weight: bold;
            padding: 1px 2px;
            border-radius: 2px;
        }
        
        .orf-highlight {
            font-weight: bold;
            background-color: #e8f4fd;
            color: #2c3e50;
            padding: 1px 2px;
            border-radius: 2px;
        }
        
        .utr-highlight {
            font-weight: bold;
            background-color: #fff3cd;
            color: #2c3e50;
            padding: 1px 2px;
            border-radius: 2px;
        }
        
        /* Table styling */
        .table {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .table th {
            font-weight: 600;
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }
        .table td {
            vertical-align: middle;
            font-size: 14px;
        }
        
        /* Card headers */
        .card-header h6 {
            font-weight: 600;
            color: #495057;
        }
        
        /* Headings */
        h2, h5, h6 {
            font-weight: 600;
            color: #2c3e50;
        }
        
        /* Buttons */
        .btn {
            font-weight: 500;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* Badges and alerts */
        .badge, .alert {
            font-weight: 500;
        }
    </style>
    <script>
        // Disable right-click context menu
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });
        
        // Disable keyboard shortcuts for developer tools
        document.addEventListener('keydown', function(e) {
            // Disable F12 key
            if (e.key === 'F12') {
                e.preventDefault();
                return false;
            }
            
            // Disable Ctrl+Shift+I (Developer Tools)
            if (e.ctrlKey && e.shiftKey && e.key === 'I') {
                e.preventDefault();
                return false;
            }
            
            // Disable Ctrl+Shift+J (Console)
            if (e.ctrlKey && e.shiftKey && e.key === 'J') {
                e.preventDefault();
                return false;
            }
            
            // Disable Ctrl+U (View Source)
            if (e.ctrlKey && e.key === 'u') {
                e.preventDefault();
                return false;
            }
            
            // Disable Ctrl+Shift+C (Inspect Element)
            if (e.ctrlKey && e.shiftKey && e.key === 'C') {
                e.preventDefault();
                return false;
            }
        });
        
        // Disable console access
        console.log = function() {};
        console.info = function() {};
        console.warn = function() {};
        console.error = function() {};
        console.debug = function() {};
        
        // Disable alert override attempts
        window.alert = function() {};
        
        // Disable eval
        window.eval = function() {};
        
        // Disable Function constructor
        window.Function = function() {};
    </script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-dna me-2"></i>Primerly
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav ms-auto">
                    <a class="nav-link" href="/">Home</a>
                    <a class="nav-link" href="/about">About Primerly</a>
                    <a class="nav-link" href="/learn">Learn</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Primer Design Results</h2>
                    <div>
                        <a href="/learn" class="btn btn-outline-info me-2">Learn Primer Design</a>
                        <a href="/" class="btn btn-outline-primary">Design New Primers</a>
                    </div>
                </div>
                
                <!-- Experiment Info -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5>Experiment Information</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <strong>Experiment Type:</strong> {{ experiment_type.replace('_', ' ').title() }}
                            </div>
                            <div class="col-md-4">
                                <strong>Sequence Length:</strong> {{ sequence_length }} bp
                            </div>
                            <div class="col-md-4">
                                <strong>Primers Found:</strong> {{ primers|length }}
                            </div>
                        </div>
                        {% if orf_info %}
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <h6 class="alert-heading">CDS Information (Largest ORF)</h6>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <strong>ORF Length:</strong> {{ orf_info.length if orf_info and orf_info.length else 'N/A' }} bp
                                        </div>
                                        <div class="col-md-3">
                                            <strong>Position:</strong> {{ (orf_info.start + 1) if orf_info and orf_info.start is not none else 'N/A' }}-{{ orf_info.end if orf_info and orf_info.end else 'N/A' }}
                                        </div>
                                        <div class="col-md-3">
                                            <strong>Reading Frame:</strong> {{ orf_info.frame if orf_info and orf_info.frame else 'N/A' }}
                                        </div>
                                        <div class="col-md-3">
                                            <strong>Coverage:</strong> {{ "%.1f"|format((orf_info.length / sequence_length) * 100) if orf_info and orf_info.length and sequence_length else 'N/A' }}%
                                        </div>
                                    </div>
                                    <small class="text-muted">
                                        Primers are designed to amplify the entire coding sequence (CDS) region.
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if utr_info %}
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="alert alert-warning">
                                    <h6 class="alert-heading">3' UTR Information</h6>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <strong>3' UTR Length:</strong> {{ utr_info.length if utr_info and utr_info.length else 'N/A' }} bp
                                        </div>
                                        <div class="col-md-3">
                                            <strong>Position:</strong> {{ (utr_info.start + 1) if utr_info and utr_info.start is not none else 'N/A' }}-{{ utr_info.end if utr_info and utr_info.end else 'N/A' }}
                                        </div>
                                        <div class="col-md-3">
                                            <strong>ORF End:</strong> {{ utr_info.orf_end if utr_info and utr_info.orf_end else 'N/A' }}
                                        </div>
                                        <div class="col-md-3">
                                            <strong>Coverage:</strong> {{ "%.1f"|format((utr_info.length / sequence_length) * 100) if utr_info and utr_info.length and sequence_length else 'N/A' }}%
                                        </div>
                                    </div>
                                    <small class="text-muted">
                                        Primers are designed to amplify the 3' untranslated region (UTR) after the coding sequence.
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Primer Results -->
                {% for primer in primers %}
                <div class="card primer-card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Primer Pair {{ loop.index }}</h5>
                            <span class="badge quality-badge bg-{{ 'success' if primer.score >= 80 else 'warning' if primer.score >= 60 else 'danger' }}">
                                {{ primer.score_label }}
                            </span>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Score Display -->
                        <div class="d-flex align-items-center mb-3">
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between mb-1">
                                    <small>Score: {{ primer.score }}/100</small>
                                    <small>{{ 'Excellent' if primer.score >= 80 else 'Good' if primer.score >= 60 else 'Needs improvement' }}</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- CDS Coverage Display -->
                        {% if primer.cds_coverage %}
                        <div class="alert alert-info mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-percentage me-2"></i>
                                <div>
                                    <strong>CDS Coverage:</strong> {{ primer.cds_coverage }}
                                    {% if primer.cds_coverage_label %}
                                    <br><small class="text-muted">{{ primer.cds_coverage_label }}</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- 3' UTR Coverage Display -->
                        {% if primer.utr_coverage %}
                        <div class="alert alert-warning mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-percentage me-2"></i>
                                <div>
                                    <strong>3' UTR Coverage:</strong> {{ primer.utr_coverage }}
                                    {% if primer.utr_coverage_label %}
                                    <br><small class="text-muted">{{ primer.utr_coverage_label }}</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Primer Sequences -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6>Forward Primer</h6>
                                <div class="sequence-highlight">
                                    {{ primer.forward }}
                                </div>
                                <small class="text-muted">Position: {{ primer.forward_start }}-{{ primer.forward_end }}</small>
                            </div>
                            <div class="col-md-6">
                                <h6>Reverse Primer</h6>
                                <div class="sequence-highlight">
                                    {{ primer.reverse }}
                                </div>
                                <small class="text-muted">Position: {{ primer.reverse_start }}-{{ primer.reverse_end }}</small>
                            </div>
                        </div>

                        <!-- Individual Sequence View Buttons for each primer -->
                        <div class="mb-4">
                            <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#sequenceView{{ loop.index }}" aria-expanded="false" aria-controls="sequenceView{{ loop.index }}">
                                Sequence View - Primer Pair {{ loop.index }}
                            </button>
                            
                            <div class="collapse mt-3" id="sequenceView{{ loop.index }}">
                                <div class="card">
                                    <div class="card-body">
                                        <h6>Sequence View - Primer Pair {{ loop.index }}</h6>
                                        
                                        <!-- Individual Primer Color Legend -->
                                        <div class="mb-3">
                                            <h6 class="text-muted">Primer Color Legend:</h6>
                                            <div class="d-flex flex-wrap">
                                                {% if loop.index == 1 %}
                                                <div class="primer-legend">
                                                    <span class="primer-highlight bg-primary me-1">F1</span>
                                                    <span class="primer-highlight bg-danger me-1">R1</span>
                                                    <small>Primer Pair 1 (Blue/Red)</small>
                                                </div>
                                                {% elif loop.index == 2 %}
                                                <div class="primer-legend">
                                                    <span class="primer-highlight bg-success me-1">F2</span>
                                                    <span class="primer-highlight bg-warning me-1">R2</span>
                                                    <small>Primer Pair 2 (Green/Orange)</small>
                                                </div>
                                                {% elif loop.index == 3 %}
                                                <div class="primer-legend">
                                                    <span class="primer-highlight bg-info me-1">F3</span>
                                                    <span class="primer-highlight bg-secondary me-1">R3</span>
                                                    <small>Primer Pair 3 (Cyan/Gray)</small>
                                                </div>
                                                {% elif loop.index == 4 %}
                                                <div class="primer-legend">
                                                    <span class="primer-highlight bg-pair4f me-1">F4</span>
                                                    <span class="primer-highlight bg-pair4r me-1">R4</span>
                                                    <small>Primer Pair 4 (Purple/Teal)</small>
                                                </div>
                                                {% elif loop.index == 5 %}
                                                <div class="primer-legend">
                                                    <span class="primer-highlight bg-pair5f me-1">F5</span>
                                                    <span class="primer-highlight bg-pair5r me-1">R5</span>
                                                    <small>Primer Pair 5 (Pink/Brown)</small>
                                                </div>
                                                {% elif loop.index == 6 %}
                                                <div class="primer-legend">
                                                    <span class="primer-highlight bg-pair6f me-1">F6</span>
                                                    <span class="primer-highlight bg-pair6r me-1">R6</span>
                                                    <small>Primer Pair 6 (Indigo/Amber)</small>
                                                </div>
                                                {% elif loop.index == 7 %}
                                                <div class="primer-legend">
                                                    <span class="primer-highlight bg-pair7f me-1">F7</span>
                                                    <span class="primer-highlight bg-pair7r me-1">R7</span>
                                                    <small>Primer Pair 7 (Cyan/Lime)</small>
                                                </div>
                                                {% elif loop.index == 8 %}
                                                <div class="primer-legend">
                                                    <span class="primer-highlight bg-pair8f me-1">F8</span>
                                                    <span class="primer-highlight bg-pair8r me-1">R8</span>
                                                    <small>Primer Pair 8 (Navy/Coral)</small>
                                                </div>
                                                {% elif loop.index == 9 %}
                                                <div class="primer-legend">
                                                    <span class="primer-highlight bg-pair9f me-1">F9</span>
                                                    <span class="primer-highlight bg-pair9r me-1">R9</span>
                                                    <small>Primer Pair 9 (Slate/Gold)</small>
                                                </div>
                                                {% elif loop.index == 10 %}
                                                <div class="primer-legend">
                                                    <span class="primer-highlight bg-pair10f me-1">F10</span>
                                                    <span class="primer-highlight bg-pair10r me-1">R10</span>
                                                    <small>Primer Pair 10 (Maroon/Sky)</small>
                                                </div>
                                                {% endif %}
                                                {% if orf_info %}
                                                <div class="primer-legend">
                                                    <span class="orf-highlight me-1">ORF</span>
                                                    <small>Coding Sequence (Light Blue Background)</small>
                                                </div>
                                                {% endif %}
                                                {% if utr_info %}
                                                <div class="primer-legend">
                                                    <span class="utr-highlight me-1">3' UTR</span>
                                                    <small>3' Untranslated Region (Light Yellow Background)</small>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <div class="sequence-container">
                                            <div class="sequence-display">
                                                <div class="sequence-text">
                                                    {% set individual_sequence = individual_highlighted_sequences[loop.index0] %}
                                                    {% for i in range(0, individual_sequence|length, 80) %}
                                                    <div class="sequence-line">
                                                        <span class="line-number">{{ "%4d"|format(i+1) }}</span>
                                                        <span class="sequence-content">
                                                            {% for j in range(i, i+80) %}
                                                                {% if j < individual_sequence|length %}
                                                                    {% set base = individual_sequence[j] %}
                                                                    {% if base.color_class %}
                                                                        <span class="primer-highlight {{ base.color_class }}">{{ base.char }}</span>
                                                                    {% else %}
                                                                        <span class="sequence-char">{{ base.char }}</span>
                                                                    {% endif %}
                                                                {% endif %}
                                                            {% endfor %}
                                                        </span>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Analysis Grid -->
                        <div class="row">
                            <div class="col-md-8">
                                <!-- Primer Properties Table -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h6 class="mb-0">Primer Properties Table</h6>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <table class="table table-bordered mb-0">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th style="width: 30%;">Parameter</th>
                                                        <th style="width: 20%;">Forward Primer</th>
                                                        <th style="width: 20%;">Reverse Primer</th>
                                                        <th style="width: 30%;">Quality Analysis</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <!-- Melting Temperature -->
                                                    <tr>
                                                        <td><strong>Melting Temperature (Tm)</strong></td>
                                                        <td>{{ primer.forward_tm }}°C</td>
                                                        <td>{{ primer.reverse_tm }}°C</td>
                                                        <td>
                                                            {% if primer.forward_tm >= 58 and primer.forward_tm <= 62 and primer.reverse_tm >= 58 and primer.reverse_tm <= 62 %}
                                                                <span class="text-success">✓ Optimal range (58-62°C)</span>
                                                            {% elif primer.forward_tm >= 55 and primer.forward_tm <= 65 and primer.reverse_tm >= 55 and primer.reverse_tm <= 65 %}
                                                                <span class="text-warning">⚠ Acceptable range (55-65°C)</span>
                                                            {% else %}
                                                                <span class="text-danger">✗ Outside optimal range</span>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    
                                                    <!-- GC Content -->
                                                    <tr>
                                                        <td><strong>GC Content</strong></td>
                                                        <td>{{ primer.forward_gc }}%</td>
                                                        <td>{{ primer.reverse_gc }}%</td>
                                                        <td>
                                                            {% if primer.forward_gc >= 40 and primer.forward_gc <= 60 and primer.reverse_gc >= 40 and primer.reverse_gc <= 60 %}
                                                                <span class="text-success">✓ Balanced GC content</span>
                                                            {% elif primer.forward_gc >= 30 and primer.forward_gc <= 70 and primer.reverse_gc >= 30 and primer.reverse_gc <= 70 %}
                                                                <span class="text-warning">⚠ Acceptable GC range</span>
                                                            {% else %}
                                                                <span class="text-danger">✗ Extreme GC content</span>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    
                                                    <!-- Primer Length -->
                                                    <tr>
                                                        <td><strong>Primer Length</strong></td>
                                                        <td>{{ primer.forward_length }} bp</td>
                                                        <td>{{ primer.reverse_length }} bp</td>
                                                        <td>
                                                            {% if primer.forward_length >= 18 and primer.forward_length <= 25 and primer.reverse_length >= 18 and primer.reverse_length <= 25 %}
                                                                <span class="text-success">✓ Optimal length (18-25 bp)</span>
                                                            {% elif primer.forward_length >= 15 and primer.forward_length <= 30 and primer.reverse_length >= 15 and primer.reverse_length <= 30 %}
                                                                <span class="text-warning">⚠ Acceptable length</span>
                                                            {% else %}
                                                                <span class="text-danger">✗ Length outside range</span>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    
                                                    <!-- GC Clamp -->
                                                    <tr>
                                                        <td><strong>GC Clamp (3' end)</strong></td>
                                                        <td>
                                                            {% if primer.forward_gc_clamp %}
                                                                <span class="text-success">Yes</span>
                                                                <small class="d-block text-muted">Strong 3' binding</small>
                                                            {% else %}
                                                                <span class="text-warning">No</span>
                                                                <small class="d-block text-muted">Weak 3' binding</small>
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            {% if primer.reverse_gc_clamp %}
                                                                <span class="text-success">Yes</span>
                                                                <small class="d-block text-muted">Strong 3' binding</small>
                                                            {% else %}
                                                                <span class="text-warning">No</span>
                                                                <small class="d-block text-muted">Weak 3' binding</small>
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            {% if primer.forward_gc_clamp and primer.reverse_gc_clamp %}
                                                                <span class="text-success">✓ Both primers have GC clamps</span>
                                                            {% elif primer.forward_gc_clamp or primer.reverse_gc_clamp %}
                                                                <span class="text-warning">⚠ One primer lacks GC clamp</span>
                                                            {% else %}
                                                                <span class="text-danger">✗ No GC clamps present</span>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    
                                                    <!-- Hairpin Structure -->
                                                    <tr>
                                                        <td><strong>Hairpin Structure</strong></td>
                                                        <td>
                                                            {{ primer.forward_hairpin_dg }} kcal/mol
                                                            <small class="d-block text-{{ 'danger' if primer.hairpin_risky else 'success' }}">
                                                                {{ 'Forms hairpin' if primer.hairpin_risky else 'No hairpin' }}
                                                            </small>
                                                        </td>
                                                        <td>
                                                            {{ primer.reverse_hairpin_dg }} kcal/mol
                                                            <small class="d-block text-{{ 'danger' if primer.hairpin_risky else 'success' }}">
                                                                {{ 'Forms hairpin' if primer.hairpin_risky else 'No hairpin' }}
                                                            </small>
                                                        </td>
                                                        <td>
                                                            {% if primer.forward_hairpin_dg > -3 and primer.reverse_hairpin_dg > -3 %}
                                                                <span class="text-success">✓ No hairpin formation</span>
                                                            {% elif primer.forward_hairpin_dg <= -3 or primer.reverse_hairpin_dg <= -3 %}
                                                                <span class="text-warning">⚠ Less than –3 kcal/mol — May form secondary structure — redesign recommended.</span>
                                                            {% else %}
                                                                <span class="text-danger">✗ Hairpin formation detected</span>
                                                                <small class="d-block text-muted">May reduce primer efficiency</small>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    
                                                    <!-- Self-Dimer -->
                                                    {% if mode == 'expert' %}
                                                    <tr>
                                                        <td><strong>Self-Dimer ΔG</strong></td>
                                                        <td>{{ primer.forward_dimer_dg }} kcal/mol</td>
                                                        <td>{{ primer.reverse_dimer_dg }} kcal/mol</td>
                                                        <td>
                                                            {% if primer.forward_dimer_dg > -6 and primer.reverse_dimer_dg > -6 %}
                                                                <span class="text-success">✓ Acceptable stability</span>
                                                            {% elif (primer.forward_dimer_dg <= -6 or primer.reverse_dimer_dg <= -6) %}
                                                                <span class="text-warning">⚠ Less than –6 kcal/mol and sticks at the 3′ end — Might cause issues — consider redesigning.</span>
                                                            {% else %}
                                                                <span class="text-danger">✗ High self-dimer formation</span>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    
                                                    <!-- Hetero-Dimer -->
                                                    <tr>
                                                        <td><strong>Hetero-Dimer ΔG</strong></td>
                                                        <td colspan="2" class="text-center">{{ primer.hetero_dimer_dg }} kcal/mol</td>
                                                        <td>
                                                            {% if primer.hetero_dimer_dg > -7 %}
                                                                <span class="text-success">✓ Acceptable stability</span>
                                                            {% elif primer.hetero_dimer_dg <= -7 %}
                                                                <span class="text-warning">⚠ Less than –7 kcal/mol and sticks at the 3′ end — Could interfere with PCR — test first or redesign if needed.</span>
                                                            {% else %}
                                                                <span class="text-danger">✗ High hetero-dimer formation</span>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    {% endif %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <!-- Dimer Visualizations -->
                                {% if mode == 'expert' %}
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Dimer Structure Analysis</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="structure-diagram">
                                                    <small class="text-muted">Forward Self-Dimer:</small>
                                                    <div class="structure-art">
                                                        <pre>{{ primer.forward_self_dimer.visualization }}</pre>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="structure-diagram">
                                                    <small class="text-muted">Reverse Self-Dimer:</small>
                                                    <div class="structure-art">
                                                        <pre>{{ primer.reverse_self_dimer.visualization }}</pre>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="structure-diagram">
                                                    <small class="text-muted">Hetero-Dimer:</small>
                                                    <div class="structure-art">
                                                        <pre>{{ primer.hetero_dimer_viz.visualization }}</pre>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>

                            <div class="col-md-4">
                                <!-- Product Size and Additional Info -->
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0">Product Information</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-12">
                                                <p><strong>Product Size:</strong> {{ primer.product_size }} bp</p>
                                                <p><strong>Amplicon Range:</strong> {{ primer.forward_start }}-{{ primer.reverse_end }}</p>
                                                {% if experiment_type == 'qpcr' %}
                                                    <div class="alert alert-info">
                                                        <small><strong>qPCR Optimized:</strong> Product size is suitable for real-time PCR amplification.</small>
                                                    </div>
                                                {% elif experiment_type == 'standard_pcr' %}
                                                    <div class="alert alert-info">
                                                        <small><strong>Standard PCR:</strong> Product size is appropriate for traditional PCR amplification.</small>
                                                    </div>
                                                {% endif %}
                                                {% if primer.full_gene_coverage %}
                                                    <div class="alert alert-success">
                                                        <small><strong>Full Gene Coverage:</strong> {{ primer.full_gene_coverage }}</small>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Why Choose This Primer -->
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Why Choose This Primer?</h6>
                                    </div>
                                    <div class="card-body">
                                        <ul class="list-unstyled small">
                                            {% if primer.forward_tm >= 58 and primer.forward_tm <= 62 and primer.reverse_tm >= 58 and primer.reverse_tm <= 62 %}
                                            <li class="mb-2">
                                                <span class="text-success">✓</span> 
                                                <strong>Perfect Tm:</strong> Both primers have optimal melting temperature (58-62°C)
                                            </li>
                                            {% endif %}
                                            {% if primer.forward_gc >= 40 and primer.forward_gc <= 60 and primer.reverse_gc >= 40 and primer.reverse_gc <= 60 %}
                                            <li class="mb-2">
                                                <span class="text-success">✓</span> 
                                                <strong>Balanced GC:</strong> Ideal GC content (40-60%) for stable annealing
                                            </li>
                                            {% endif %}
                                            {% if primer.forward_gc_clamp and primer.reverse_gc_clamp %}
                                            <li class="mb-2">
                                                <span class="text-success">✓</span> 
                                                <strong>GC Clamps:</strong> Both primers end with G/C for strong 3' binding
                                            </li>
                                            {% endif %}
                                            {% if primer.forward_hairpin_dg > -3 and primer.reverse_hairpin_dg > -3 %}
                                            <li class="mb-2">
                                                <span class="text-success">✓</span> 
                                                <strong>No Hairpins:</strong> Clean secondary structure for efficient amplification
                                            </li>
                                            {% endif %}
                                            {% if primer.forward_dimer_dg > -6 and primer.reverse_dimer_dg > -6 %}
                                            <li class="mb-2">
                                                <span class="text-success">✓</span> 
                                                <strong>Safe Self-Dimer:</strong> Minimal self-dimer formation risk
                                            </li>
                                            {% endif %}
                                            {% if primer.hetero_dimer_dg > -7 %}
                                            <li class="mb-2">
                                                <span class="text-success">✓</span> 
                                                <strong>Safe Hetero-Dimer:</strong> Minimal primer-primer interaction
                                            </li>
                                            {% endif %}
                                            {% if primer.product_size >= 80 and primer.product_size <= 200 and experiment_type == 'qpcr' %}
                                            <li class="mb-2">
                                                <span class="text-success">✓</span> 
                                                <strong>qPCR Ready:</strong> Perfect size (80-200 bp) for real-time PCR
                                            </li>
                                            {% elif primer.product_size >= 200 and primer.product_size <= 1000 and experiment_type == 'standard_pcr' %}
                                            <li class="mb-2">
                                                <span class="text-success">✓</span> 
                                                <strong>Standard PCR:</strong> Ideal amplicon size (200-1000 bp) for traditional PCR
                                            </li>
                                            {% endif %}
                                            {% if primer.forward_length >= 18 and primer.forward_length <= 25 and primer.reverse_length >= 18 and primer.reverse_length <= 25 %}
                                            <li class="mb-2">
                                                <span class="text-success">✓</span> 
                                                <strong>Optimal Length:</strong> Both primers are ideal length (18-25 bp)
                                            </li>
                                            {% endif %}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}

                <!-- Download Button -->
                <div class="text-center mt-4">
                    <button class="btn btn-success" onclick="downloadCSV()">Download Results as CSV</button>
                </div>
                
                <!-- Bottom panels for Early Access and Upcoming Features -->
                <div class="row mt-5">
                    <div class="col-md-6 mb-3">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h6 class="mb-2">Early Access</h6>
                                <p class="small mb-2"><strong>First 1,000 users</strong> get discount and advanced features.</p>
                                <button class="btn btn-sm btn-success w-100" data-bs-toggle="modal" data-bs-target="#earlyAccessModal">Join Early Access</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h6 class="mb-2">Upcoming Features</h6>
                                <p class="small mb-2">Interested in ordering primers when we launch?</p>
                                <div class="d-flex align-items-center mb-2">
                                    <button id="interest-btn" class="btn btn-sm btn-outline-primary me-2">I'd order</button>
                                    <span class="small text-muted">Interest: <span id="interest-count">0</span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <footer class="text-center text-muted mt-5">
                    <p>
                        <img src="/static/logo.png" alt="Biovagon" class="logo-small me-2">
                        &copy; 2025 Primerly - A Biovagon Initiative | Version 1.0.0 | MIT License
                    </p>
                    <p class="small">
                        <a href="/" class="text-decoration-none">Design New Primers</a> | 
                        <a href="/learn" class="text-decoration-none">Learn More</a> | 
                        <a href="/version" class="text-decoration-none">Version Info</a> |
                        <a href="https://www.biovagon.org/" target="_blank" class="text-decoration-none">Biovagon</a> |
                        <span class="text-muted">Primer Designs: <span id="design-count">—</span></span>
                    </p>
                </footer>
            </div>
        </div>
    </div>

    <!-- Early Access Modal -->
    <div class="modal fade" id="earlyAccessModal" tabindex="-1" aria-labelledby="earlyAccessModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="earlyAccessModalLabel">Join Early Access</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <h4 class="text-primary">🌟 Be Among the First 1,000 Users!</h4>
                        <p class="mb-3">Join our early access community and unlock exclusive perks:</p>
                        <div class="text-start">
                            <p class="mb-2">💸 <strong>Special discounts</strong> on primer orders (delivered within 5–10 days)</p>
                            <p class="mb-2">⚙️ <strong>Advanced features</strong> and priority support</p>
                            <p class="mb-2">🚀 <strong>Early access</strong> to new Biovagon tools and updates</p>
                            <p class="mb-3">💬 <strong>Share your opinions</strong> — help shape Primerly's next generation</p>
                            <p class="small text-muted">✨ Your feedback drives innovation. Join today and be part of Biovagon's first 1,000 researchers!</p>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" id="ea-name" placeholder="Your name">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="ea-email" placeholder="you@example.com">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone (optional)</label>
                        <input type="text" class="form-control" id="ea-phone" placeholder="Optional">
                    </div>
                    <div id="ea-error" class="text-danger small d-none"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="submitEarlyAccess()">Join Early Access</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function downloadCSV() {
            const primers = {{ primers|tojson }};
            fetch('/download-csv', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ primers: primers })
            })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'primers.csv';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            });
        }

        // Real-time analytics system
        let analyticsInterval;

        // Load stats function
        async function loadStats() {
            try {
                const res = await fetch('/stats');
                const data = await res.json();
                if (data && !data.error) {
                    const dc = document.getElementById('design-count');
                    const ic = document.getElementById('interest-count');
                    if (dc) dc.textContent = data.primer_designs ?? '0';
                    if (ic) ic.textContent = data.order_interest ?? '0';
                    return data;
                }
            } catch (error) {
                console.log('Analytics load failed:', error);
            }
            return { primer_designs: 0, order_interest: 0 };
        }

        // Start real-time analytics refresh
        function startAnalyticsRefresh() {
            // Load immediately
            loadStats();
            
            // Then refresh every 3 seconds for real-time updates
            analyticsInterval = setInterval(loadStats, 3000);
        }

        // Stop analytics refresh (for cleanup)
        function stopAnalyticsRefresh() {
            if (analyticsInterval) {
                clearInterval(analyticsInterval);
                analyticsInterval = null;
            }
        }

        // Initialize analytics on page load
        document.addEventListener('DOMContentLoaded', startAnalyticsRefresh);

        // Cleanup on page unload
        window.addEventListener('beforeunload', stopAnalyticsRefresh);

        // Interest button
        const interestBtn = document.getElementById('interest-btn');
        if (interestBtn) {
            interestBtn.addEventListener('click', async () => {
                try {
                    const res = await fetch('/order-interest', { method: 'POST' });
                    const data = await res.json();
                    if (data && !data.error) {
                        // Update immediately
                        const ic = document.getElementById('interest-count');
                        if (ic) ic.textContent = data.order_interest ?? '0';
                        interestBtn.disabled = true;
                        interestBtn.textContent = 'Thanks!';
                        
                        // Refresh all analytics to sync across pages
                        loadStats();
                    }
                } catch {}
            });
        }

        // Handle early access form submission
        function submitEarlyAccess() {
            const name = document.getElementById('ea-name').value;
            const email = document.getElementById('ea-email').value;
            const phone = document.getElementById('ea-phone').value;
            
            if (!name || !email) {
                alert('Please enter your name and email address');
                return;
            }

            fetch('/early-access-signup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    email: email,
                    phone: phone
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Thank you for joining Early Access! We\'ll be in touch soon.');
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('earlyAccessModal'));
                    modal.hide();
                    // Reset form
                    document.getElementById('ea-name').value = '';
                    document.getElementById('ea-email').value = '';
                    document.getElementById('ea-phone').value = '';
                } else {
                    alert('Error: ' + (data.error || 'Please try again'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error submitting form. Please try again.');
            });
        }
    </script>
</body>
</html> 